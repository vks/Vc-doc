<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Vc: Portability Issues</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Vc"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Vc
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">SIMD Vector Classes for C++</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.php" method="get">
              <img id="MSearchSelect" src="search/mag.png" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('portability.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Portability Issues </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>One of the major goals of Vc is to ease development of portable code, while achieving highest possible performance that requires target architecture specific instructions. This is possible through having just a single type use different implementations of the same API depending on the target architecture. Many of the details of the target architecture are often dependent on the compiler flags that were used. Also there can be subtle differences between the implementations that could lead to problems. This page aims to document all issues you might need to know about.</p>
<dl class="section user"><dt>Compiler Flags</dt><dd></dd></dl>
<ul>
<li><em>GCC:</em> The compiler should be called with the -march=&lt;target&gt; flag. Take a look at the GCC manpage to find all possibilities for &lt;target&gt;. Additionally it is best to also add the -msse2 -msse3 ... -mavx flags. If no SIMD instructions are enabled via compiler flags, Vc must fall back to the scalar implementation. </li>
<li><em>Clang:</em> The same as for GCC applies. </li>
<li><em>ICC:</em> Same as GCC, but the flags are called -xAVX -xSSE4.2 -xSSE4.1 -xSSSE3 -xSSE3 -xSSE2. </li>
<li><em>MSVC:</em> On 32bit you can add the /arch:SSE2 flag. That's about all the MSVC documentation says. Still the MSVC compiler knows about the newer instructions in SSE3 and upwards. How you can determine what CPUs will be supported by the resulting binary is unclear.</li>
</ul>
<dl class="section user"><dt>Where does the final executable run?</dt><dd></dd></dl>
<p>You must be aware of the fact that a binary that is built for a given SIMD hardware may not run on a processor that does not have these instructions. The executable will work fine as long as no such instruction is actually executed and only crash at the place where such an instruction is used. Thus it is better to check at application start whether the compiled in SIMD hardware is really supported on the executing CPU. This can be determined with the currentImplementationSupported function.</p>
<p>If you want to distribute a binary that runs correctly on many different systems you either must restrict it to the least common denominator (which often is SSE2), or you must compile the code several times, with the different target architecture compiler options. A simple way to combine the resulting executables would be via a wrapping script/executable that determines the correct executable to use. A more sophisticated option is the use of the ifunc attribute GCC provides. Other compilers might provide similar functionality.</p>
<dl class="section user"><dt>Guarantees</dt><dd></dd></dl>
<p>It is guaranteed that: </p><ul>
<li><div class="fragment"><div class="line">int_v::Size == uint_v::Size == float_v::Size </div>
</div><!-- fragment --> </li>
<li><div class="fragment"><div class="line">short_v::Size == ushort_v::Size </div>
</div><!-- fragment --></li>
</ul>
<dl class="section user"><dt>Important Differences between Implementations</dt><dd></dd></dl>
<ul>
<li>Obviously the number of entries in a vector depends on the target architecture. </li>
<li>Hardware that does not support 16-Bit integer vectors can implement the short_v and ushort_v API via 32-Bit integer vectors. Thus, some of the overflow behavior might be slightly different, and truncation will only happen when the vector is stored to memory.</li>
</ul>
<h1><a class="anchor" id="portability_compilerquirks"></a>
Compiler Quirks</h1>
<p>Since SIMD is not part of the C/C++ language standards Vc abstracts more or less standardized compiler extensions. Sadly, not every issue can be transparently abstracted. Therefore this will be the place where differences are documented: </p><ul>
<li>MSVC is incapable of parameter passing by value, if the type has alignment restrictions. The consequence is that all Vc vector types and any type derived from <a class="el" href="group__Utilities.html#gae0b1347db1c228fa9eed28bb263b7ce1" title="Helper type to ensure suitable alignment for any Vc::Vector<T> type (using the default VectorAbi)...">Vc::VectorAlignedBase</a> cannot be used as function parameters, unless a pointer is used (this includes reference and const-reference). So<div class="fragment"><div class="line"><span class="keywordtype">void</span> foo(<a class="code" href="classVc_1_1float__v.html">Vc::float_v</a>) {}</div>
</div><!-- fragment --> does not compile, while<div class="fragment"><div class="line"><span class="keywordtype">void</span> foo(<a class="code" href="classVc_1_1float__v.html">Vc::float_v</a> &amp;) {}</div>
<div class="line"><span class="keywordtype">void</span> foo(<span class="keyword">const</span> <a class="code" href="classVc_1_1float__v.html">Vc::float_v</a> &amp;) {}</div>
<div class="line"><span class="keywordtype">void</span> foo(<a class="code" href="classVc_1_1float__v.html">Vc::float_v</a> *) {}</div>
</div><!-- fragment --> all work. Normally you should prefer passing by value since a sane compiler will then pass the data in a register and does not have to store/load the data to/from the stack. Vc defines <code>Vc_PASSING_VECTOR_BY_VALUE_IS_BROKEN</code> for such cases. Also the Vc vector types contain a composite typedef <code>AsArg</code> which resolves to either const-ref or const-by-value. Thus, you can always use <div class="fragment"><div class="line"><span class="keywordtype">void</span> foo(Vc::float_v::AsArg) {}</div>
</div><!-- fragment -->. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
